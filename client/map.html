<!DOCTYPE html>
<html>
  <head>
    <title>Chalice GIS Demo</title>
    <meta charset="utf-8"/>
    <link rel="stylesheet" href="https://openlayers.org/en/v4.6.4/css/ol.css" type="text/css">
    <script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
    <!-- The line below is only needed for old environments like Internet Explorer and Android 4.x -->
    <script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=requestAnimationFrame,Element.prototype.classList,URL"></script>
    <script src="https://openlayers.org/en/v4.6.4/build/ol.js"></script>
  </head>
  <body>
    <div id="map1" class="map"></div>

    <script>
      /**
       * Helper method for map-creation.
       *
       * @param {string} divId The id of the div for the map.
       * @return {ol.PluggableMap} The ol.Map instance.
       */
      var createMap = function(divId) {
        var source, layer, map, zoomslider;

        source = new ol.source.OSM();
        layer = new ol.layer.Tile({
          source: source
        });
        
        pointLayer = new ol.layer.Vector({
          source: new ol.source.Vector({
            features: []
          }),
          style: function(feature) {
            // hide geoMarker if animation is active
            if (animating && feature.get('type') === 'geoMarker') {
              return null;
            }
            return styles[feature.get('type')];
          }
        });       

        map = new ol.Map({
          project: "EPSG:4326",
          layers: [layer, pointLayer],
          target: divId,
          view: new ol.View({
            center: ol.proj.fromLonLat([-74.9045388866985,42.2217382933897]),
            zoom: 9
          })
        });
        zoomslider = new ol.control.ZoomSlider();
        map.addControl(zoomslider);
        return map;
      };

      var map1 = createMap('map1');

      // https://stackoverflow.com/questions/12460378/how-to-get-json-from-url-in-javascript
      // let url = 'http://localhost:8000/restaurants/facility_address/51%20FOX%20STREET';
      /*
      let url = 'http://localhost:8000/restaurants';
      fetch(url)
      .then(res => res.json())
      .then((out) => {
        console.log('RESPONSE: ', out);
      })
      .catch(err => { throw err });
      */

      function successHandler(data) {
        dataString = JSON.stringify(data);
        dataString = dataString.replace(/\\/g,'');
        dataString = dataString.replace(/\'/g,'\"');
        dataString = dataString.replace(/"S/g, "\'S");
        dataString = dataString.replace(/'\[/g, '[');
        dataString = dataString.replace(/]'/g, ']');
        dataString = dataString.replace(/"\[/g, '[');
        dataString = dataString.replace(/]"/g, ']');       
        var jsonData = JSON.parse(dataString);  
        console.log(jsonData);

        for (var i = 0; i < jsonData.length; i++) {
          console.log(jsonData[i]);
        }
        
        //data.results(function(item) {
         // console.log("RESULT ITEM: " + item);
          // create a new feature with the item as the properties
          //var feature = new ol.Feature(item);
          // create an appropriate geometry and add it to the feature
          // var coordinate = transform([parseFloat(item.longitude), parseFloat(item.latitude)]);
          //var coordinate = [parseFloat(item.longitude), parseFloat(item.latitude)];
          //var geometry = new ol.geom.Point(coordinate);
         // feature.setGeometry(geometry);
          // add the feature to the source
          // flickrSource.addFeature(feature);
        //  pointLayer.source.addFeature(feature);
      //});
    }


    $.ajax({
      url: 'http://localhost:8000/restaurants/facility_address/51%20FOX%20STREET',
      dataType: 'json',
      success: successHandler
     });

    </script>

  </body>
</html>
