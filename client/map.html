<!DOCTYPE html>
<html>
  <head>
    <title>Chalice GIS Demo</title>
    <meta charset="utf-8"/>
    <link rel="stylesheet" href="https://openlayers.org/en/v4.6.4/css/ol.css" type="text/css">
    <script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
    <!-- The line below is only needed for old environments like Internet Explorer and Android 4.x -->
    <script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=requestAnimationFrame,Element.prototype.classList,URL"></script>
    <script src="https://openlayers.org/en/v4.6.4/build/ol.js"></script>
  </head>
  <body>
    <style>
    #map {
      width: 100%;
      height: 100%;
    }
    </style>
    <div id="mapDiv" class="map"></div>
    <label id"queryLabel" name="queryLabel">REST URL QUERY: </label>
    <form id="queryInput" name="queryInput">
      <select id="querySelect" name="querySelect">
        <option value="/restaurants/limit/100" selected>/restaurants/limit/100</option>
        <option value="/restaurants/facility/MIDNIGHT MIKE'S">/restaurants/facility/MIDNIGHT MIKE'S</option>
        <option value="/restaurants/facility_address/9632 ROUTE 96">/restaurants/facility_address/9632 ROUTE 96</option>
        <option value="/restaurants/circle/42.095128,-76.064429,290.4">/restaurants/circle/42.095128,-76.064429,290.4</option>
        <option value="/restaurants/bbox/43.106171,-76.265024,42.000000,-75.000000">/restaurants/bbox/43.106171,-76.265024,42.000000,-75.000000</option>
      </select>
      <button id="querySubmit" name="querySubmit" type="button">Run Query</button>
    </div>
    <script>
    var service = "http://localhost:8000"
    var source = new ol.source.OSM();
    var layer = new ol.layer.Tile({
      name: "tileLayer",
      source: source
    });

    var iconStyle = new ol.style.Style({
      image: new ol.style.Icon(/** @type {olx.style.IconOptions} */ ({
        color: '#FF00FF',
        crossOrigin: 'anonymous',
        opacity: 0.75,
        src: 'img/dot.png'
      }))
    });

    var map = new ol.Map({
      /* project: "EPSG:4326", */
      project: "EPSG:3857",
      layers: [layer],
      target: "mapDiv",
      view: new ol.View({
        center: ol.proj.fromLonLat([-75.2326641,43.1009031]),
        zoom: 7
      })
    });
    var zoomslider = new ol.control.ZoomSlider();
    map.addControl(zoomslider);
     

    function successHandler(data) {
      dataString = JSON.stringify(data);
      dataString = dataString.replace(/\\/g,'');
      dataString = dataString.replace(/'\[/g, '[');
      dataString = dataString.replace(/]'/g, ']');
      dataString = dataString.replace(/"\[/g, '[');
      dataString = dataString.replace(/]"/g, ']');      
      var jsonData = JSON.parse(dataString);  

      var vectorSource = new ol.source.Vector({});

      let vectorLayerArray = new Array();
      map.getLayers().getArray().some(function(layer, i, array) {
        if (layer instanceof ol.layer.Vector) {
          map.removeLayer(layer);
        }
      }, this);
           
      for (var i = 0; i < jsonData.results.length; i++) {
        var coordinate = [parseFloat(jsonData.results[i].longitude), parseFloat(jsonData.results[i].latitude)];
        var geom = new ol.geom.Point(ol.proj.fromLonLat(coordinate));
        var feature = new ol.Feature({geometry: geom});
        vectorSource.addFeature(feature);
      }

      var pointLayer = new ol.layer.Vector({
        name: "pointLayer",
        source: vectorSource,
        style: iconStyle
      }); 
      
      map.addLayer(pointLayer);
      map.render();
    }

    $(document).ready(function(){
      $("#querySubmit").click(function(){ 
        $.ajax({
          url: service + document.queryInput.querySelect.value,
          dataType: 'json',
          success: successHandler
         });
       });
     });
    </script>

  </body>
</html>
